{% extends "base.html" %}

{% block title %}Заявки на закупку - Stolovaia{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <h1>Заявки на закупку продуктов</h1>

    <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
        <a href="/cook_inventory_manage/" class="btn" style="background: #17a2b8; color: white;">← Вернуться к учету продуктов</a>
    </div>

{% if low_stock_items %}
<div style="margin: 40px 0; border: 1px solid #dee2e6; border-radius: 5px; padding: 20px; background: #f8f9fa;">
    <h2 style="color: #495057;">Автоматические заявки на закупку</h2>
    <p>Эти продукты заканчиваются. Создайте заявки одним кликом:</p>

    <div style="margin: 15px 0;">
        <table style="width: 100%; border-collapse: collapse; background: white;">
            <thead>
                <tr style="background-color: #e9ecef;">
                    <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left;">Продукт</th>
                    <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left;">Осталось</th>
                    <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left;">Заказывать при остатке</th>
                    <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left;">Действие</th>
                </tr>
            </thead>
            <tbody>
                {% for item in low_stock_items %}
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 10px; font-weight: bold;">
                        {{ item[1] }}
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 10px;">
                        {{ item[2] }} {{ item[3] if item[3] else 'ед.' }}
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 10px;">
                        {{ item[4] if item[4] else 'не задано' }} {{ item[3] if item[3] and item[4] else '' }}
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 10px;">
                        <a href="#createForm" onclick="fillForm('{{ item[1] }}', '{{ (item[4]*2 - item[2])|round(1) if item[4] and item[2] and item[4]*2 > item[2] else item[4] if item[4] else 10 }}', '{{ item[3] if item[3] else "кг" }}', 'Низкий остаток: {{ item[2] }} {{ item[3] if item[3] else "ед." }}')"
                           style="padding: 5px 10px; background: #6c757d; color: white; border-radius: 3px; text-decoration: none; font-size: 12px;">
                            Создать заявку
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <form method="POST" action="/cook_purchase_request/">
        <input type="hidden" name="action" value="create_from_low_stock">
        <button type="submit" style="padding: 12px 25px; background: #495057; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
            Создать заявки на ВСЕ продукты выше
        </button>
        <small style="display: block; margin-top: 10px; color: #6c757d;">Будут созданы заявки с высоким приоритетом</small>
    </form>
</div>
{% else %}
<div style="margin: 20px 0; padding: 15px; background: #e9ecef; border: 1px solid #dee2e6; border-radius: 5px;">
    <p>Все продукты на складе в норме. Нет срочных заявок на закупку.</p>
</div>
{% endif %}
    <div id="createForm" style="margin: 40px 0; border: 1px solid #dee2e6; border-radius: 5px; padding: 20px;">
        <h2>Создать новую заявку на закупку</h2>

        <form method="POST" action="/cook_purchase_request/" style="margin-top: 20px;">
            <input type="hidden" name="action" value="create_request">

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                        Что покупаем:
                    </label>
                    <select name="item_name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                        <option value="">-- Выберите продукт --</option>
                        {% for product in all_products %}
                        <option value="{{ product[0] }}">{{ product[0] }} ({{ product[1] }})</option>
                        {% endfor %}
                        <option value="Другое">Другое (ввести вручную)</option>
                    </select>
                    <input type="text" name="item_name_custom" placeholder="Введите название нового продукта"
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 10px; display: none;"
                           id="custom_item_name">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                        Количество:
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" name="quantity" required min="0.1" step="0.1" placeholder="10.5"
                               style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <select name="unit" required style="width: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="кг">кг</option>
                            <option value="г">г</option>
                            <option value="л">л</option>
                            <option value="шт">шт</option>
                            <option value="уп">уп</option>
                            <option value="бан">бан</option>
                        </select>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                        Примерная цена (руб.):
                    </label>
                    <input type="number" name="price" min="0" step="0.01" placeholder="1500.00"
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                        Приоритет:
                    </label>
                    <select name="priority" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="high">Высокий (продукт заканчивается)</option>
                        <option value="normal" selected>Обычный (плановый заказ)</option>
                        <option value="low">Низкий (можно подождать)</option>
                    </select>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">Причина закупки:</label>
                <textarea name="reason" rows="3" placeholder="Например: Для приготовления обедов на следующую неделю. Или: Закончилось на складе."
                          style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;"></textarea>
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <button type="submit" style="padding: 12px 40px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 18px;">
                    Отправить заявку администратору
                </button>
            </div>
        </form>
    </div>

    <div style="margin: 40px 0; border: 1px solid #dee2e6; border-radius: 5px; padding: 20px;">
        <h2>Мои заявки на покупку</h2>

        {% if user_requests %}
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr style="background-color: #f8f9fa;">
                    <th style="border: 1px solid #dee2e6; padding: 12px;">Продукт</th>
                    <th style="border: 1px solid #dee2e6; padding: 12px;">Количество</th>
                    <th style="border: 1px solid #dee2e6; padding: 12px;">Цена</th>
                    <th style="border: 1px solid #dee2e6; padding: 12px;">Приоритет</th>
                    <th style="border: 1px solid #dee2e6; padding: 12px;">Статус</th>
                    <th style="border: 1px solid #dee2e6; padding: 12px;">Дата</th>
                    <th style="border: 1px solid #dee2e6; padding: 12px;">Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for req in user_requests %}
                {% set status_color = {'pending': '#ffc107', 'approved': '#28a745', 'rejected': '#dc3545'} %}
                {% set priority_color = {'high': '#dc3545', 'normal': '#17a2b8', 'low': '#6c757d'} %}
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 12px;">
                        <strong>{{ req[1] }}</strong>
                        {% if req[5] %}
                        <br><small style="color: #666;">{{ req[5]|truncate(30) }}</small>
                        {% endif %}
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 12px;">
                        {{ req[2] }} {{ req[3] }}
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 12px;">
                        {% if req[4] > 0 %}
                        {{ "%.2f"|format(req[4]) }} руб.
                        {% else %}
                        <span style="color: #666;">не указана</span>
                        {% endif %}
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 12px;">
                        <span style="color: {{ priority_color.get(req[6], '#666') }}; font-weight: bold;">
                            {% if req[6] == 'high' %}Высокий
                            {% elif req[6] == 'normal' %}Обычный
                            {% elif req[6] == 'low' %}Низкий
                            {% endif %}
                        </span>
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 12px;">
                        <span style="color: {{ status_color.get(req[7], '#666') }}; font-weight: bold;">
                            {% if req[7] == 'pending' %}Ожидает
                            {% elif req[7] == 'approved' %}Одобрено
                            {% elif req[7] == 'rejected' %}Отклонено
                            {% endif %}
                        </span>
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 12px;">
                        {{ req[8][:10] }}
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 12px;">
                        {% if req[7] == 'pending' %}
                        <button onclick="showEditForm({{ req[0] }}, '{{ req[1] }}', {{ req[2] }}, {{ req[4] }}, '{{ req[5] }}', '{{ req[6] }}')"
                                style="padding: 5px 10px; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">

                        </button>
                        <form method="POST" action="/cook_purchase_request/{{ req[0] }}" style="display: inline;">
                            <input type="hidden" name="action" value="delete">
                            <button type="submit" onclick="return confirm('Удалить заявку на {{ req[1] }}?')"
                                    style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">

                            </button>
                        </form>
                        {% else %}
                        <span style="color: #666;">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 5px;">
            <p style="font-size: 18px;">У вас нет заявок на покупку</p>
            <p>Создайте первую заявку с помощью формы выше</p>
        </div>
        {% endif %}
    </div>
</div>

<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 8px; width: 500px; max-width: 90%;">
        <h3>✏️ Редактировать заявку</h3>
        <form id="editForm" method="POST" action="">
            <input type="hidden" name="action" value="update">

            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">Количество:</label>
                <input type="number" id="editQuantity" name="quantity" required min="0.1" step="0.1"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">Цена (руб.):</label>
                <input type="number" id="editPrice" name="price" min="0" step="0.01"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">Приоритет:</label>
                <select id="editPriority" name="priority" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="high">Высокий</option>
                    <option value="normal">Обычный</option>
                    <option value="low">Низкий</option>
                </select>
            </div>

            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">Причина:</label>
                <textarea id="editReason" name="reason" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Сохранить
                </button>
                <button type="button" onclick="hideEditForm()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Переключение между выбором продукта и ручным вводом
document.querySelector('select[name="item_name"]').addEventListener('change', function() {
    const customInput = document.getElementById('custom_item_name');
    if (this.value === 'Другое') {
        customInput.style.display = 'block';
        customInput.required = true;
        customInput.name = 'item_name';
        this.name = 'item_name_old';
    } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.name = 'item_name_custom';
        this.name = 'item_name';
    }
});

// Заполнение формы из таблицы низких остатков
function fillForm(itemName, quantity, unit, reason) {
    document.querySelector('select[name="item_name"]').value = itemName;
    document.querySelector('input[name="quantity"]').value = quantity;
    document.querySelector('select[name="unit"]').value = unit;
    document.querySelector('textarea[name="reason"]').value = reason;
    document.querySelector('select[name="priority"]').value = 'high';

    // Прокрутка к форме
    document.getElementById('createForm').scrollIntoView({ behavior: 'smooth' });
}

// Функции для редактирования заявки
function showEditForm(requestId, itemName, quantity, price, reason, priority) {
    const form = document.getElementById('editForm');
    form.action = `/cook_purchase_request/${requestId}`;

    document.getElementById('editQuantity').value = quantity;
    document.getElementById('editPrice').value = price || '';
    document.getElementById('editReason').value = reason || '';
    document.getElementById('editPriority').value = priority;

    document.getElementById('editModal').style.display = 'flex';
}

function hideEditForm() {
    document.getElementById('editModal').style.display = 'none';
}

// Закрытие модального окна при клике на фон
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideEditForm();
    }
});
</script>

<style>
.btn {
    display: inline-block;
    padding: 10px 15px;
    background: #f5f5f5;
    border: 1px solid #aaa;
    border-radius: 3px;
    text-decoration: none;
    color: #333;
}
.btn:hover {
    background: #e0e0e0;
}
</style>
{% endblock %}