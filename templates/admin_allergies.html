{% extends "base.html" %}

{% block title %}Статистика по аллергиям - Stolovaia{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <h1>Статистика по пищевым аллергиям и предпочтениям</h1>

    <div style="margin: 20px 0; display: flex; gap: 10px;">
        <a href="/admin_stats/" class="btn">Общая статистика</a>
        <a href="/admin_purchase_manage/" class="btn">Заявки на закупку</a>
        <a href="/admin_report/" class="btn">Отчеты</a>
    </div>

    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 30px 0;">
        <div style="border: 2px solid #28a745; padding: 15px; border-radius: 5px; text-align: center;">
            <h3 style="margin: 0 0 10px 0;">Всего учеников</h3>
            <p style="font-size: 32px; font-weight: bold; margin: 0; color: #28a745;">{{ total_students }}</p>
        </div>
        <div style="border: 2px solid #17a2b8; padding: 15px; border-radius: 5px; text-align: center;">
            <h3 style="margin: 0 0 10px 0;">С аллергиями</h3>
            <p style="font-size: 32px; font-weight: bold; margin: 0; color: #17a2b8;">{{ with_allergies }}</p>
            <small>{{ (with_allergies/total_students*100 if total_students>0 else 0)|round(1) }}%</small>
        </div>
        <div style="border: 2px solid #ffc107; padding: 15px; border-radius: 5px; text-align: center;">
            <h3 style="margin: 0 0 10px 0;">Особые предпочтения</h3>
            <p style="font-size: 32px; font-weight: bold; margin: 0; color: #ffc107;">{{ with_preferences }}</p>
            <small>{{ (with_preferences/total_students*100 if total_students>0 else 0)|round(1) }}%</small>
        </div>
    </div>

    <div style="margin: 40px 0;">
        <h2>Распространенные аллергии</h2>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 15px;">
            {% for allergy in common_allergies %}
            <div style="border: 1px solid #dee2e6; padding: 15px; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 style="margin: 0;">{{ allergy.name }}</h4>
                    <span style="background: #17a2b8; color: white; padding: 5px 10px; border-radius: 10px;">
                        {{ allergy.count }} учеников
                    </span>
                </div>
                <p style="margin-top: 10px; color: #666;">
                    {% for student in allergy.students[:3] %}
                    {{ student }}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if allergy.count > 3 %}...{% endif %}
                </p>
                <div style="margin-top: 10px;">
                    <div style="background: #e9ecef; height: 10px; border-radius: 5px;">
                        <div style="background: #17a2b8; height: 100%; width: {{ (allergy.count/total_students*100 if total_students>0 else 0) }}%; border-radius: 5px;"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div style="margin: 40px 0;">
        <h2>Диетические предпочтения</h2>
        <div style="margin-top: 15px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th style="border: 1px solid #dee2e6; padding: 10px;">Предпочтение</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px;">Количество учеников</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px;">Примеры</th>
                    </tr>
                </thead>
                <tbody>
                    {% for preference in common_preferences %}
                    <tr>
                        <td style="border: 1px solid #dee2e6; padding: 10px;">
                            <strong>{{ preference.name }}</strong>
                        </td>
                        <td style="border: 1px solid #dee2e6; padding: 10px;">
                            {{ preference.count }}
                            <small>({{ (preference.count/total_students*100 if total_students>0 else 0)|round(1) }}%)</small>
                        </td>
                        <td style="border: 1px solid #dee2e6; padding: 10px;">
                            {{ preference.students[:3]|join(', ') }}
                            {% if preference.count > 3 %}...{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div style="margin: 40px 0;">
        <h2>Все ученики</h2>
        <div style="margin-top: 15px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th style="border: 1px solid #dee2e6; padding: 10px;">Имя</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px;">Класс</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px;">Аллергии</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px;">Предпочтения</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in all_students %}
                    <tr>
                        <td style="border: 1px solid #dee2e6; padding: 10px;">
                            <strong>{{ student.full_name }}</strong>
                        </td>
                        <td style="border: 1px solid #dee2e6; padding: 10px;">{{ student.class }}</td>
                        <td style="border: 1px solid #dee2e6; padding: 10px;">
                            {% if student.allergies and student.allergies != 'Нет' %}
                            <span style="color: #dc3545;">{{ student.allergies }}</span>
                            {% else %}
                            <span style="color: #666;">Нет</span>
                            {% endif %}
                        </td>
                        <td style="border: 1px solid #dee2e6; padding: 10px;">
                            {% if student.preferences and student.preferences != 'Нет' %}
                            <span style="color: #17a2b8;">{{ student.preferences }}</span>
                            {% else %}
                            <span style="color: #666;">Нет</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.btn {
    display: inline-block;
    padding: 10px 15px;
    background: #f5f5f5;
    border: 1px solid #aaa;
    border-radius: 3px;
    text-decoration: none;
    color: #333;
}
.btn:hover {
    background: #e0e0e0;
}
</style>
{% endblock %}